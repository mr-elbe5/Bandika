<?xml version="1.0" encoding="UTF-8"?>
<project name="CmsSample" default="createProjectWar" basedir=".">

    <property file="build.properties" />

    <property name="project" value="CmsSample" />
    <property name="build.dir" location="build/${project}" />
    <property name="buildSrc.dir" location="${build.dir}/src" />
    <property name="buildClasses.dir" location="${build.dir}/classes" />
    <property name="buildLibs.dir" location="${build.dir}/libs" />
    <property name="deploy.dir" location="${deploy.root}/cmsSample" />

    <path id="classpath">
        <fileset dir="${buildLibs.dir}"/>
        <fileset dir="libs">
            <include name="catalina.jar"/>
            <include name="jasper.jar"/>
            <include name="jsp-api.jar"/>
            <include name="servlet-api.jar"/>
        </fileset>
    </path>

    <!-- Target for deleting the existing directories-->
    <target name="clean">
        <delete dir="${buildSrc.dir}" />
        <delete dir="${buildClasses.dir}" />
        <delete dir="${buildLibs.dir}" />
    </target>

    <target name="makeDirs">
        <mkdir dir="${build.dir}" />
        <mkdir dir="${buildSrc.dir}" />
        <mkdir dir="${buildClasses.dir}" />
        <mkdir dir="${buildLibs.dir}" />
    </target>

    <target name="collectBandikaBaseFiles" depends="makeDirs">
        <copy todir="${buildSrc.dir}" overwrite="true">
            <fileset dir="BandikaBase/src" />
        </copy>
        <copy todir="${buildLibs.dir}">
            <fileset dir="libs" >
                <include name="commons*.jar"/>
                <include name="mail.jar"/>
                <include name="json*.jar"/>
                <include name="jsoup*.jar"/>
            </fileset>
        </copy>
    </target>

    <target name="createBootstrapCss">
        <apply executable="sass" dest="Bandika/web/static-content/css" verbose="true" force="true" failonerror="true">
            <srcfile />
            <targetfile />
            <file name="Bandika/scss/bootstrap.scss" />
            <mapper type="glob" from="*.scss" to="*.css"/>
        </apply>
    </target>

    <target name="createBandikaCss">
        <apply executable="sass" dest="Bandika/web/static-content/css" verbose="true" force="true" failonerror="true">
            <srcfile />
            <targetfile />
            <file name="Bandika/scss/bandika.scss" />
            <mapper type="glob" from="*.scss" to="*.css"/>
        </apply>
    </target>

    <target name="collectBandikaFiles" depends="collectBandikaBaseFiles, createBootstrapCss, createBandikaCss">
        <copy todir="${buildSrc.dir}" overwrite="true">
            <fileset dir="Bandika/src" />
        </copy>
    </target>

    <target name="collectBandikaContentFiles" depends="collectBandikaFiles">
        <copy todir="${buildSrc.dir}" overwrite="true">
            <fileset dir="BandikaContent/src" />
        </copy>
    </target>

    <target name="collectBandikaCmsFiles" depends="collectBandikaContentFiles">
        <copy todir="${buildSrc.dir}" overwrite="true">
            <fileset dir="BandikaCms/src" />
        </copy>
    </target>

    <target name="compile" depends="makeDirs">
        <javac srcdir="${buildSrc.dir}" destdir="${buildClasses.dir}" includeantruntime="false" debug="true" source="15" target="15">
            <classpath>
                <path refid="classpath"/>
            </classpath>
        </javac>
        <copy todir="${buildClasses.dir}" overwrite="true">
            <fileset dir="${buildSrc.dir}" >
                <include name="**/*.properties"/>
            </fileset>
        </copy>
    </target>

    <target name="createProjectCss">
        <apply executable="sass" dest="${project}/web/static-content/css" verbose="true" force="true" failonerror="true">
            <srcfile />
            <targetfile />
            <file name="${project}/scss/layout.scss" />
            <mapper type="glob" from="*.scss" to="*.css"/>
        </apply>
    </target>

    <target name="collectProjectFiles" depends="collectBandikaFiles,
    collectBandikaContentFiles, collectBandikaCmsFiles,
    createProjectCss">
        <copy todir="${buildSrc.dir}" overwrite="true">
            <fileset dir="${project}/src" />
        </copy>
    </target>

    <target name="createProjectWar" depends="collectProjectFiles, compile">
        <war destfile="${build.dir}/ROOT.war"
             webxml="${project}/web/WEB-INF/web.xml">
            <classes dir="${buildClasses.dir}"/>
            <fileset dir="Bandika/web" />
            <fileset dir="BandikaContent/web" />
            <fileset dir="BandikaCms/web" />
            <fileset dir="${project}/web" >
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
            <lib dir="${buildLibs.dir}"/>
        </war>
    </target>

    <target name="deployProject" depends="createProjectWar">
        <copy todir="${deploy.dir}" overwrite="true">
            <file name="${build.dir}/ROOT.war"/>
        </copy>
    </target>

    <target name="undeployProject">
        <delete file="${deploy.dir}/ROOT.war" />
    </target>

</project>